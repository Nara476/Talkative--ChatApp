<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="style.css">
    <title>Spring Boot WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>

<body>
    <h2>WebSocket Chat</h2>
    <input type="text" id="username" placeholder="Enter your name" />
    <button id="connectBtn" onclick="connect()">Connect</button>
    <div id="chat" style="border:1px solid #ccc; height:300px; overflow-y:auto; padding:10px; margin:10px 0;"></div>
    <input type="text" id="message" placeholder="Type your message here..." />
    <button onclick="sendMessage()">Send</button>

    <script>
        let stompClient = null;
        let username = null;

        function connect() {
            if (stompClient && stompClient.connected) {
                console.log("Already connected");
                return;
            }

            username = document.getElementById('username').value.trim();
            if (!username) {
                alert("Please enter a username.");
                return;
            }

            const socket = new SockJS('http://localhost:8080/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // Disable connect button
                document.getElementById('connectBtn').disabled = true;

                // Subscribe to public topic
                stompClient.subscribe('/topic/public', function (messageOutput) {
                    const message = JSON.parse(messageOutput.body);
                    if (message.type === 'CHAT') {
                        showMessage(message.sender + ': ' + message.message);
                    } else if (message.type === 'JOIN') {
                        showMessage(message.sender + ' joined the chat');
                    } else if (message.type === 'LEAVE') {
                        showMessage(message.sender + ' left the chat');
                    }
                });

                // Send join message
                stompClient.send("/app/chat.sendmessage", {}, JSON.stringify({
                    sender: username,
                    type: 'JOIN'
                }));
            });
        }

        function sendMessage() {
            const messageContent = document.getElementById('message').value.trim();
            if (messageContent && stompClient && stompClient.connected) {
                const chatMessage = {
                    sender: username,
                    content: messageContent,
                    type: 'CHAT',
                    message: messageContent
                };
                stompClient.send("/app/chat.sendmessage", {}, JSON.stringify(chatMessage));
                document.getElementById('message').value = '';
            }
        }

        function showMessage(message) {
            const chat = document.getElementById('chat');
            const messageElement = document.createElement('p');
            messageElement.textContent = message;
            chat.appendChild(messageElement);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>

</html>